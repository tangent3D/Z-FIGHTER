# Building and Loading Z-FIGHTER Software

Z-FIGHTER uses a cross-platform build system using z88dk/zsdcc and GNU Make.

### Getting Started
1. Install z88dk for your platform according to these [instructions](https://github.com/z88dk/z88dk/wiki/installation). If applicable, follow any additional instructions for zsdcc. If using Windows, install a port of GNU Make, e.g. [Make for Windows](http://gnuwin32.sourceforge.net/packages/make.htm) or MinGW. Add the location of `make.exe` to your PATH.
2. Navigate your shell to the Z-FIGHTER software directory (the location of this readme) and execute `make`. Z-FIGHTER's development library and software will immediately begin compiling![^1]
3. Create a text file named `.env` in this directory containing a definition for Z-FIGHTER's Makefile's `com_port` environment variable specifying the address of your serial communications device, e.g. `com_port=COM1`, `com_port=/dev/ttyS1`, or `com_port=/dev/ttyUSB1`.[^2]
4. Install [z80com](https://github.com/tangent3D/z80com) by pointing your shell to its root directory and executing `pip install -e .`

### Preparing for Serial Communication with Z-FIGHTER
Z-FIGHTER's build system is configured to work with a boot loader ROM, `zf_loader/zf_loader.rom`, to be burned to the SST39SF040 EEPROM on-board Z-FIGHTER. Functionality can be verified by connecting your serial communications device to Z-FIGHTER's SIO/0 **Ch.A** port (furthest from power port). Configure your preferred terminal emulator for 115200 baud, 8-N-1 (8 data bits, no parity, 1 stop bit) and RTS/CTS flow control. Upon power-up or reset, Z-FIGHTER should transmit the text `[Z-FIGHTER Serial Boot Loader v0.3]` Z-FIGHTER is ready to load a program into memory!

### Transferring Programs to Z-FIGHTER with zf_loader
Navigate your shell to the `game` or `demo` directory of your choice and execute `make send`. A binary will be immediately loaded into Z-FIGHTER RAM and executed. Upon program exit or system reset, Z-FIGHTER will return to the boot loader, ready to load another program into memory.

# Developing Z-FIGHTER Software

### Make Targets
#### 'bin' (Default) Target[^3]
Produces a '.ram' file intended for loading via zf_loader. By default, this target produces binaries intended to be executed from RAM. Compression can be enabled when using this target by specifying `compress=true`.
#### 'asm' (Standalone ASM Project) Target
Assembles a standalone ASM project using `z80asm`. The first module to be assembled must be specified with the `file` environment variable, e.g. `file=program.asm`. Additional source files should be included with `INCLUDE` and `INCBIN` directives. Code and data sections should be located with `ORG` directives. Reference to Z-FIGHTER library components is supported via `EXTERN` directives. An example of a project assembled with this target is [`zf_loader`](https://github.com/tangent3D/Z-FIGHTER/blob/main/src/zf_serial_loader/zf_loader.asm).
#### Generating ROMs
Binaries intended to be burned directly to Z-FIGHTER's EEPROM can be generated by specifying `rom=true`. This will produce a '.rom' file designed for Z-FIGHTER's default memory map of ROM = 0x0000-0x7FFF, RAM = 0x8000-0xFFFF.

### A Note about Z-FIGHTER Front Panel Peripherals
Before using the front panel accessories (LCD, buzzer, keypad) in your program, Z-FIGHTER's parallel I/O chip should be initialized. The `bin` target includes `zf_init.asm` on the compile line and initialization will automatically occur during the CRT startup code. To manually initialize the parallel I/O chip, only one call of `zf_init()` (defined in `zf_init.h`) is necessary. This can be implemented in ASM projects with `EXTERN _zf_init` and `CALL _zf_init`.

[^1]:If you've compiled z88dk from source and `z80.lib` is not found when linking, navigate to `z88dk/libsrc/_DEVELOPMENT` and execute `make` to build the z80 libraries separately.
[^2]:If no `.env` file is present, `com_port` will need to be specified on the command line or in your project's Makefile when `send` and `term` operations are performed.
[^3]:Uses z88dk's [`Embedded_Z80`](https://github.com/z88dk/z88dk/wiki/NewLib--Platform--Embedded) target.
[^4]:While this practice is not discouraged, it should be considered a stopgap measure until a system ROM that loads software into RAM from the CompactFlash card is created.
[^5]:Refer to [this](https://github.com/tangent3D/Z-FIGHTER/blob/main/SPLD/readme.md) page for information about modifying Z-FIGHTER's memory map.
